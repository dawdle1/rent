<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bike Rental</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body { font-family: Arial, sans-serif; margin: 0; background:#f5f5f5; }
.no-scroll { overflow: hidden; height: 100%; }

header { background:#111; color:#fff; padding:15px; text-align:center; }
.container { max-width:1200px; margin:auto; padding:15px; }
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:15px; }
.card { background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,.1); }
.card img { width:100%; height:180px; object-fit:cover; cursor:pointer; }
.card-body { padding:10px; }
.price { font-weight:bold; }
.status.free { color:green; }
.status.booked { color:red; }

button.book-btn {
  width:100%; margin-top:10px; padding:10px;
  background:#111; color:#fff; border:none; cursor:pointer;
  border-radius:4px;
}

/* Lightbox */
.lightbox {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.9);
  display:none; align-items:center; justify-content:center;
  z-index:1000; touch-action: pan-x;
}
.lightbox.show { display:flex; }
.lightbox img { max-width:95%; max-height:95%; }
.lightbox .close {
  position:absolute; top:20px; right:25px;
  font-size:30px; color:#fff; cursor:pointer;
}
.lightbox .nav {
  position:absolute; top:50%; transform:translateY(-50%);
  font-size:40px; color:#fff; cursor:pointer;
  padding:10px; user-select:none;
}
.lightbox .prev { left:20px; }
.lightbox .next { right:20px; }

/* Modal */
.modal {
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  display:none; align-items:center; justify-content:center;
  z-index:1100;
}
.modal.show { display:flex; }
.modal-content {
  background:#fff; padding:20px;
  border-radius:8px; width:90%; max-width:400px;
}
.modal-content input {
  width:100%; padding:8px; margin-bottom:10px;
}
.modal-content button {
  width:100%; padding:10px;
  background:#111; color:#fff; border:none; cursor:pointer;
}
.modal-close { text-align:right; cursor:pointer; color:#999; }
</style>
</head>
<body>

<header><h1>Bike Rental</h1></header>

<div class="container">
  <div id="grid" class="grid"></div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox">
  <span class="close" onclick="closeLightbox()">√ó</span>
  <span class="nav prev" onclick="lbPrev()">‚Äπ</span>
  <img id="lightbox-img" src="" />
  <span class="nav next" onclick="lbNext()">‚Ä∫</span>
</div>

<!-- Booking -->
<div id="bookingModal" class="modal">
  <div class="modal-content">
    <div class="modal-close" onclick="closeBooking()">‚úï</div>
    <h3>Book bike</h3>

    <input id="bk_name" placeholder="Your name" inputmode="text" />
    <input id="bk_contact" placeholder="+66XXXXXXXXX" type="tel" />
    
    <label>From:</label>
    <input id="bk_from" type="date" />
    <label>To:</label>
    <input id="bk_to" type="date" />

    <input id="bk_bike" readonly />
    <button onclick="sendBooking()">Send booking</button>
    <p id="bk_status"></p>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQkiyZdafVIMIamvuz4dP7PvJwfuzIYAw0k1_NjhQYbpFNCz7jfb0xn3blCawJrIfZuUgC4beUQd8vP/pub?gid=510031858&single=true&output=csv";
const IMAGE_PATH = "Images/";

const TOKEN = "8569147206:AAFvjIvwo6PbwrGkrGjnXArUVqxtoF9G5E4";
const CHAT_ID = "166993928";

let lbImages = [], lbIndex = 0;

function parseCSV(text) {
  const rows = [];
  let row = [], cell = "", inside = false;
  for (let c of text) {
    if (c === '"') inside = !inside;
    else if (c === ',' && !inside) { row.push(cell); cell = ""; }
    else if ((c === '\n' || c === '\r') && !inside) {
      if (cell || row.length) { row.push(cell); rows.push(row); }
      row = []; cell = "";
    } else cell += c;
  }
  if (cell || row.length) { row.push(cell); rows.push(row); }
  return rows;
}

fetch(CSV_URL).then(r=>r.text()).then(text=>{
  const data = parseCSV(text);
  const headers = data[0];
  const rows = data.slice(1);
  const bikes = rows.map(r=>{
    const o={}; headers.forEach((h,i)=>o[h.trim()]=(r[i]||"").trim()); return o;
  });
  render(bikes);
});

function render(bikes){
  const grid = document.getElementById("grid");
  grid.innerHTML="";
  bikes.forEach(b=>{
    let images = b.image_urls
      ? b.image_urls.split("|").map(x=>IMAGE_PATH+x.trim()).filter(x=>x)
      : ["https://via.placeholder.com/400x300?text=No+Image"];

    let idx=0;
    const card=document.createElement("div"); card.className="card";
    const img=document.createElement("img"); img.src=images[0];
    img.onclick=()=>openLightbox(images,idx);
    card.appendChild(img);

    const body=document.createElement("div");
    body.className="card-body";
    body.innerHTML=`
      <div><b>${b.brand} ${b.model}</b> ${b.year||""}</div>
      <div class="price">Day: ${b.price_day_thb||"-"} THB</div>
      <div class="price">Month: ${b.price_month_thb||"-"} THB</div>
    `;
    const btn=document.createElement("button");
    btn.className="book-btn"; btn.textContent="Book";
    btn.onclick=()=>openBooking(`${b.brand} ${b.model}`);
    body.appendChild(btn);

    card.appendChild(body);
    grid.appendChild(card);
  });
}

// Lightbox
function openLightbox(images,i){
  lbImages=images; lbIndex=i;
  document.getElementById("lightbox-img").src=lbImages[lbIndex];
  document.getElementById("lightbox").classList.add("show");
  document.body.classList.add("no-scroll");
}
function closeLightbox(){
  document.getElementById("lightbox").classList.remove("show");
  document.body.classList.remove("no-scroll");
}
function lbPrev(){ lbIndex=(lbIndex-1+lbImages.length)%lbImages.length;
  document.getElementById("lightbox-img").src=lbImages[lbIndex]; }
function lbNext(){ lbIndex=(lbIndex+1)%lbImages.length;
  document.getElementById("lightbox-img").src=lbImages[lbIndex]; }

// Booking
function openBooking(bike){
  bk_name.value=""; bk_contact.value="";
  bk_from.value=""; bk_to.value="";
  bk_bike.value=bike; bk_status.innerText="";
  bookingModal.classList.add("show");
  document.body.classList.add("no-scroll");
}
function closeBooking(){
  bookingModal.classList.remove("show");
  document.body.classList.remove("no-scroll");
}

// Validation
bk_name.addEventListener("input", e=>{
  e.target.value = e.target.value.replace(/[0-9]/g,"");
});
bk_contact.addEventListener("input", e=>{
  e.target.value = e.target.value.replace(/[^0-9+]/g,"");
});

function formatDate(v){
  const [y,m,d]=v.split("-");
  return `${d}/${m}/${y}`;
}

function sendBooking(){
  const name=bk_name.value.trim();
  const contact=bk_contact.value.trim();
  const from=bk_from.value;
  const to=bk_to.value;
  const bike=bk_bike.value;

  if(!name || !contact || !from || !to){
    bk_status.innerText="‚ùó Fill all fields";
    return;
  }

  const text = `üö≤ New booking!\n\nüë§ Name: ${name}\nüìû Contact: ${contact}\nüìÖ Dates: ${formatDate(from)} - ${formatDate(to)}\nüèç Bike: ${bike}`;

  fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:CHAT_ID,text})
  }).then(()=>{ bk_status.innerText="‚úÖ Sent!"; setTimeout(closeBooking,1500); })
    .catch(()=>bk_status.innerText="‚ùå Error");
}
</script>

</body>
</html>

