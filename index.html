<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bike Rental</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body { font-family: Arial, sans-serif; margin: 0; background:#f5f5f5; }
.no-scroll { overflow: hidden; height: 100%; }

header { background:#111; color:#fff; padding:15px; text-align:center; }
.container { max-width:1200px; margin:auto; padding:15px; }
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:15px; }
.card { background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,.1); }
.card img { width:100%; height:180px; object-fit:cover; cursor:pointer; }
.card-body { padding:10px; }
.price { font-weight:bold; }
.status.free { color:green; }
.status.booked { color:red; }

button.book-btn {
  width:100%; margin-top:10px; padding:10px;
  background:#111; color:#fff; border:none; cursor:pointer;
  border-radius:4px;
}

/* Lightbox */
.lightbox {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.lightbox.show { display:flex; }
.lightbox img { max-width:95%; max-height:95%; }
.lightbox .close {
  position:absolute; top:20px; right:25px;
  font-size:30px; color:#fff; cursor:pointer;
}

/* Modal */
.modal {
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1100;
}
.modal.show { display:flex; }
.modal-content {
  background:#fff; padding:20px;
  border-radius:8px; width:90%; max-width:400px;
}
.modal-content input {
  width:100%; padding:8px; margin-bottom:10px;
}
.modal-content button {
  width:100%; padding:10px;
  background:#111; color:#fff; border:none; cursor:pointer;
}
.modal-close { text-align:right; cursor:pointer; color:#999; }
</style>
</head>
<body>

<header><h1>Bike Rental</h1></header>

<div class="container">
  <div id="grid" class="grid"></div>
</div>

<div id="lightbox" class="lightbox">
  <span class="close" onclick="closeLightbox()">√ó</span>
  <img id="lightbox-img" src="" />
</div>

<div id="bookingModal" class="modal">
  <div class="modal-content">
    <div class="modal-close" onclick="closeBooking()">‚úï</div>
    <h3>Book bike</h3>

    <input id="bk_name" placeholder="Your name" />
    <input id="bk_contact" placeholder="+66 812345678" />
    <input id="bk_dates" placeholder="DD/MM/YYYY" />
    <input id="bk_bike" readonly />

    <button onclick="sendBooking()">Send booking</button>
    <p id="bk_status"></p>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQkiyZdafVIMIamvuz4dP7PvJwfuzIYAw0k1_NjhQYbpFNCz7jfb0xn3blCawJrIfZuUgC4beUQd8vP/pub?gid=510031858&single=true&output=csv";
const IMAGE_PATH = "Images/";

const TOKEN = "8569147206:AAFvjIvwo6PbwrGkrGjnXArUVqxtoF9G5E4";
const CHAT_ID = "166993928";

let lbImages = [];
let lbIndex = 0;

function parseCSV(text) {
  return text.trim().split("\n").map(r => r.split(","));
}

fetch(CSV_URL).then(r=>r.text()).then(text=>{
  const data = parseCSV(text);
  const headers = data[0];
  const rows = data.slice(1);
  const bikes = rows.map(r=>{
    const o={};
    headers.forEach((h,i)=>o[h.trim()]=(r[i]||"").trim());
    return o;
  });
  render(bikes);
});

function render(bikes){
  const grid = document.getElementById("grid");
  grid.innerHTML="";
  bikes.forEach(b=>{
    const images = b.image_urls ? b.image_urls.split("|").map(x=>IMAGE_PATH+x.trim()) : [];
    const imgSrc = images[0] || "https://via.placeholder.com/400x300";

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <img src="${imgSrc}" onclick="openLightbox(['${imgSrc}'],0)">
      <div class="card-body">
        <div><b>${b.brand} ${b.model}</b> ${b.year||""}</div>
        <div class="price">Day: ${b.price_day_thb||"-"} THB</div>
        <div class="price">Month: ${b.price_month_thb||"-"} THB</div>
        <div class="status ${b.status}">Status: ${b.status}</div>
        <button class="book-btn" onclick="openBooking('${b.brand} ${b.model}')">Book</button>
      </div>`;
    grid.appendChild(card);
  });
}

function openLightbox(images,i){
  lbImages=images; lbIndex=i;
  document.getElementById("lightbox-img").src=images[i];
  document.getElementById("lightbox").classList.add("show");
}
function closeLightbox(){
  document.getElementById("lightbox").classList.remove("show");
}

function openBooking(bike){
  document.getElementById("bk_bike").value=bike;
  document.getElementById("bk_status").innerText="";
  document.getElementById("bookingModal").classList.add("show");
}
function closeBooking(){
  document.getElementById("bookingModal").classList.remove("show");
}

// --- Validation helpers ---

const nameInput = document.getElementById("bk_name");
nameInput.addEventListener("input", ()=>{
  nameInput.value = nameInput.value.replace(/[0-9]/g,"");
});

const dateInput = document.getElementById("bk_dates");
dateInput.addEventListener("focus", ()=>{
  dateInput.type="date";
});
dateInput.addEventListener("change", ()=>{
  if(dateInput.value){
    const [y,m,d]=dateInput.value.split("-");
    dateInput.type="text";
    dateInput.value=`${d}/${m}/${y}`;
  }
});
dateInput.addEventListener("blur", ()=>{
  if(!dateInput.value) dateInput.type="text";
});

function sendBooking(){
  const name = bk_name.value.trim();
  const contact = bk_contact.value.trim();
  const dates = bk_dates.value.trim();
  const bike = bk_bike.value;

  const phoneOk = /^\+\d{1,3}\s?\d{6,14}$/.test(contact);
  const dateOk = /^\d{2}\/\d{2}\/\d{4}$/.test(dates);

  if(!name || !contact || !dates){
    bk_status.innerText="‚ùó Fill all fields";
    return;
  }
  if(!phoneOk){
    bk_status.innerText="‚ùó Phone format: +66 812345678";
    return;
  }
  if(!dateOk){
    bk_status.innerText="‚ùó Date format: DD/MM/YYYY";
    return;
  }

  const text = `üö≤ New booking!\n\nüë§ Name: ${name}\nüìû Contact: ${contact}\nüìÖ Date: ${dates}\nüèç Bike: ${bike}`;

  fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:CHAT_ID,text})
  }).then(()=> {
    bk_status.innerText="‚úÖ Sent!";
    setTimeout(closeBooking,1500);
  }).catch(()=>{
    bk_status.innerText="‚ùå Error";
  });
}
</script>

</body>
</html>
